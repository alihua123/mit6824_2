<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>checkSingle DFS 搜索树状图</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .tree-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
        }
        .tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 1200px;
        }
        .level {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            width: 100%;
        }
        .node {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            margin: 0 15px;
            border-radius: 8px;
            text-align: center;
            position: relative;
            min-width: 150px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .node.success {
            background: #27ae60;
        }
        .node.failure {
            background: #e74c3c;
        }
        .node.backtrack {
            background: #f39c12;
        }
        .node.final {
            background: #8e44ad;
        }
        .connection {
            width: 2px;
            height: 30px;
            background: #34495e;
            margin: 0 auto;
        }
        .branch-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 20px 0;
        }
        .branch {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 30px;
        }
        .branch-line {
            width: 2px;
            height: 40px;
            background: #34495e;
        }
        .horizontal-line {
            height: 2px;
            background: #34495e;
            margin: 20px 0;
        }
        .state-info {
            background: #ecf0f1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
            color: #2c3e50;
        }
        .legend {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 15px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }
        .scenario {
            margin: 40px 0;
            padding: 20px;
            border: 2px solid #3498db;
            border-radius: 8px;
        }
        .code-snippet {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .highlight {
            background: #f1c40f;
            color: #2c3e50;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌳 checkSingle DFS 搜索树状图</h1>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>初始/中间节点</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #27ae60;"></div>
                <span>操作成功</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>操作失败</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>回溯节点</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #8e44ad;"></div>
                <span>最终结果</span>
            </div>
        </div>

        <div class="scenario">
            <h2>📋 示例场景：Put("x","1") 和 Get("x") 时间重叠</h2>
            <p><strong>操作历史：</strong></p>
            <div class="code-snippet">
Put("x","1"): 调用t=10 ────── 返回t=30
Get("x"):          调用t=20 ── 返回t=40
            </div>
            <p><strong>链表结构：</strong> [Call Put] ↔ [Call Get] ↔ [Ret Put] ↔ [Ret Get]</p>
        </div>

        <div class="tree-container">
            <h3>🔍 DFS 搜索树</h3>
            <div class="tree">
                <!-- 根节点 -->
                <div class="level">
                    <div class="node">
                        开始 checkSingle<br>
                        <div class="state-info">
                            state = ""<br>
                            linearized = {}<br>
                            entry = Call Put
                        </div>
                    </div>
                </div>
                
                <div class="connection"></div>
                
                <!-- 第一层：尝试Put操作 -->
                <div class="level">
                    <div class="node">
                        尝试 Put("x","1")<br>
                        <div class="state-info">
                            model.Step(state="", Put, OK)
                        </div>
                    </div>
                </div>
                
                <div class="branch-container">
                    <div class="branch">
                        <div class="branch-line"></div>
                        <div class="node success">
                            Put 操作成功<br>
                            <div class="state-info">
                                ok = true<br>
                                newState = "x:1"<br>
                                继续 DFS
                            </div>
                        </div>
                        <div class="branch-line"></div>
                        
                        <!-- Put成功后尝试Get -->
                        <div class="node">
                            尝试 Get("x")<br>
                            <div class="state-info">
                                state = "x:1"<br>
                                entry = Call Get
                            </div>
                        </div>
                        
                        <div class="branch-container">
                            <div class="branch">
                                <div class="branch-line"></div>
                                <div class="node success">
                                    Get 返回 "1"<br>
                                    <div class="state-info">
                                        model.Step("x:1", Get, "1")<br>
                                        ok = true ✅
                                    </div>
                                </div>
                                <div class="branch-line"></div>
                                <div class="node final">
                                    成功！<br>
                                    线性化序列: [Put, Get]
                                </div>
                            </div>
                            
                            <div class="branch">
                                <div class="branch-line"></div>
                                <div class="node failure">
                                    Get 返回 "2"<br>
                                    <div class="state-info">
                                        model.Step("x:1", Get, "2")<br>
                                        ok = false ❌
                                    </div>
                                </div>
                                <div class="branch-line"></div>
                                <div class="node backtrack">
                                    跳过，尝试下一个<br>
                                    entry = entry.next
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="branch">
                        <div class="branch-line"></div>
                        <div class="node failure">
                            Put 操作失败<br>
                            <div class="state-info">
                                ok = false<br>
                                跳过 Put 操作
                            </div>
                        </div>
                        <div class="branch-line"></div>
                        
                        <!-- Put失败后尝试Get -->
                        <div class="node">
                            尝试 Get("x")<br>
                            <div class="state-info">
                                state = ""<br>
                                entry = Call Get
                            </div>
                        </div>
                        
                        <div class="branch-line"></div>
                        
                        <div class="node success">
                            Get 返回 ""<br>
                            <div class="state-info">
                                model.Step("", Get, "")<br>
                                ok = true ✅
                            </div>
                        </div>
                        
                        <div class="branch-line"></div>
                        
                        <!-- Get成功后回到Put -->
                        <div class="node">
                            回到 Put("x","1")<br>
                            <div class="state-info">
                                state = ""<br>
                                尝试剩余操作
                            </div>
                        </div>
                        
                        <div class="branch-line"></div>
                        
                        <div class="node final">
                            成功！<br>
                            线性化序列: [Get, Put]
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="scenario">
            <h2>🔄 回溯机制详解</h2>
            <div class="code-snippet">
<span class="highlight">// 当前路径失败时的回溯逻辑</span>
if len(calls) == 0 {
    return false, longest  // 无法回溯，彻底失败
}

// 回溯到上一个选择点
callsTop := calls[len(calls)-1]
entry = callsTop.entry      // 恢复到之前的操作
state = callsTop.state      // 恢复到之前的状态
linearized.clear(uint(entry.id))  // 清除线性化标记
calls = calls[:len(calls)-1]      // 弹出调用栈
unlift(entry)               // 将操作重新加入链表
<span class="highlight">entry = entry.next          // 🔑 尝试下一个可能的操作</span>
            </div>
        </div>

        <div class="scenario">
            <h2>🎯 关键代码路径</h2>
            
            <h3>1. 操作成功路径</h3>
            <div class="code-snippet">
if ok {
    // 操作合法，加入线性化序列
    newLinearized := linearized.clone().set(uint(entry.id))
    if !cacheContains(model, cache, newCacheEntry) {
        calls = append(calls, callsEntry{entry, state})
        state = newState
        linearized.set(uint(entry.id))
        <span class="highlight">lift(entry)                    // 从链表移除</span>
        <span class="highlight">entry = headEntry.next         // 继续下一个操作</span>
    }
}
            </div>

            <h3>2. 操作失败路径</h3>
            <div class="code-snippet">
} else {
    // 操作不合法，跳过该操作
    <span class="highlight">entry = entry.next  // 🔑 尝试链表中的下一个操作</span>
}
            </div>

            <h3>3. 回溯路径</h3>
            <div class="code-snippet">
} else {
    // 需要回溯
    callsTop := calls[len(calls)-1]
    entry = callsTop.entry
    state = callsTop.state
    linearized.clear(uint(entry.id))
    calls = calls[:len(calls)-1]
    <span class="highlight">unlift(entry)               // 重新加入链表</span>
    <span class="highlight">entry = entry.next          // 尝试其他操作</span>
}
            </div>
        </div>

        <div class="scenario">
            <h2>🧠 搜索策略总结</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>🔍 深度优先搜索 (DFS)</h4>
                    <ul>
                        <li>选择一个操作后，立即递归处理剩余操作</li>
                        <li>直到找到完整解或遇到死路</li>
                        <li>使用调用栈 <code>calls</code> 记录路径</li>
                    </ul>
                </div>
                <div>
                    <h4>🔄 回溯搜索</h4>
                    <ul>
                        <li>当前路径失败时，回到上一个选择点</li>
                        <li>尝试其他可能的操作</li>
                        <li>系统性地探索所有可能的执行顺序</li>
                    </ul>
                </div>
            </div>
            
            <h4>🎯 核心思想</h4>
            <p>通过 <strong>DFS + 回溯</strong> 的组合，<code>checkSingle</code> 能够：</p>
            <ol>
                <li><strong>系统性探索</strong>：尝试所有可能的操作执行顺序</li>
                <li><strong>早期剪枝</strong>：一旦找到合法序列就返回成功</li>
                <li><strong>完整性保证</strong>：只有穷尽所有可能后才返回失败</li>
                <li><strong>效率优化</strong>：使用缓存避免重复计算相同状态</li>
            </ol>
        </div>
    </div>
</body>
</html>