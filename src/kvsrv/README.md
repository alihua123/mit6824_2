# KVSrv - 键值存储服务器

## 项目简介

这是MIT 6.824分布式系统课程的实验项目，实现了一个简单但正确的键值存储服务器。该服务器支持Get、Put和Append操作，并具备以下特性：

- **并发安全**：使用互斥锁保护共享数据结构
- **重复检测**：防止网络重传导致的重复操作执行
- **容错性**：客户端具备自动重试机制
- **一致性**：保证操作的原子性和一致性

## 系统架构

### 核心组件

1. **KVServer**：服务器端，负责处理客户端请求
   - 数据存储：使用内存中的map存储键值对
   - 并发控制：使用互斥锁保证线程安全
   - 重复检测：记录客户端请求历史，避免重复执行

2. **Clerk**：客户端，提供Get/Put/Append接口
   - 唯一标识：每个客户端有唯一的ClientId
   - 请求编号：每个请求有唯一的RequestId
   - 重试机制：网络故障时自动重试

3. **RPC通信**：基于labrpc框架的远程过程调用

### 关键设计决策

#### 1. 重复检测机制
**问题**：网络不可靠可能导致请求重传，如何避免重复执行？

**解决方案**：
- 客户端为每个请求分配唯一的(ClientId, RequestId)对
- 服务器记录每个客户端的最后一次请求结果
- 重复请求直接返回缓存的结果

#### 2. Append操作的语义
**要求**：Append操作需要返回追加前的原始值

**实现**：
- 先读取当前值作为返回值
- 再执行追加操作
- 整个过程在锁保护下原子执行

#### 3. 并发控制
**挑战**：多个客户端可能同时访问同一个键

**解决方案**：
- 使用单一的互斥锁保护所有共享状态
- 简单但有效，避免了复杂的锁竞争问题

## API接口

### 客户端接口

```go
// 获取键对应的值，键不存在时返回空字符串
func (ck *Clerk) Get(key string) string

// 设置键值对
func (ck *Clerk) Put(key string, value string)

// 追加值到键的现有值后面，返回追加前的原始值
func (ck *Clerk) Append(key string, value string) string
```

### RPC接口

```go
// 服务器端RPC方法
func (kv *KVServer) Get(args *GetArgs, reply *GetReply)
func (kv *KVServer) Put(args *PutAppendArgs, reply *PutAppendReply)
func (kv *KVServer) Append(args *PutAppendArgs, reply *PutAppendReply)
```

## 使用方法

### 启动服务器
```go
kv := StartKVServer()
```

### 创建客户端
```go
ck := MakeClerk(serverEndpoint)
```

### 基本操作
```go
// 存储键值对
ck.Put("key1", "value1")

// 获取值
value := ck.Get("key1") // 返回 "value1"

// 追加值
oldValue := ck.Append("key1", "_append") // 返回 "value1"
newValue := ck.Get("key1") // 返回 "value1_append"
```

## 测试

运行测试套件：
```bash
go test
```

测试包括：
- 基本功能测试
- 并发访问测试
- 网络不可靠环境测试
- 内存使用测试
- 线性一致性测试

## 性能特性

- **时间复杂度**：所有操作都是O(1)
- **空间复杂度**：O(n)，其中n是存储的键值对数量
- **并发性能**：受限于单一互斥锁，但保证了正确性
- **容错性**：客户端自动重试，服务器重复检测

## 限制和改进方向

### 当前限制
1. 数据只存储在内存中，重启后丢失
2. 单点故障，服务器宕机后服务不可用
3. 性能受限于单一互斥锁
4. 客户端请求历史无限增长

### 可能的改进
1. 添加持久化存储
2. 实现服务器复制和故障转移
3. 使用更细粒度的锁或无锁数据结构
4. 实现客户端请求历史的垃圾回收
5. 添加负载均衡和分片支持

## 相关概念

- **线性一致性**：操作看起来是瞬时生效的
- **幂等性**：重复执行相同操作结果不变
- **原子性**：操作要么完全成功，要么完全失败
- **容错性**：系统能够处理部分组件的故障